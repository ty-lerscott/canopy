name: Deploy Canopy
description: 'Actions for deploying canopy'

on:
  workflow_call:
    inputs:
      BLUR:
        required: true
        type: string
      PORT:
        required: true
        type: string
      API_KEY:
        required: true
        type: string
      APP_ENV:
        required: true
        type: string
      NODE_ENV:
        required: true
        type: string
      SENTRY_URL:
        required: true
        type: string
      SENTRY_AUTH_TOKEN:
        required: true
        type: string
      DISCORD_WEBHOOK_URL:
        required: true
        type: string

jobs:
  deploy_canopy:
  steps:
    - name: Install dependencies
      shell: bash
      run: npm i

    - name: Build API
      shell: bash
      run: npm run build:ts

    - name: Build Apps
      shell: bash
      run: npm run build:apps

    - name: Deploy with rsync
      shell: bash
      uses: burnett01/rsync-deployments@5.2.1
      with:
        switches: -avzc --delete --exclude="*.ts" --exclude=".git"
        path: ./
        remote_path: ${{ inputs.TARGET_DIR }}
        remote_host: ${{ inputs.HOST }}
        remote_user: ${{ inputs.USER }}
        remote_key: ${{ inputs.SSH_KEY }}

    - name: Restart Canopy
      shell: bash
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ inputs.HOST }}
        username: ${{ inputs.USER }}
        key: ${{ inputs.SSH_KEY }}
        port: 22
        script: pm2 restart canopy

