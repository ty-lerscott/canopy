name: Deploy Canopy
description: 'Composite action for deployment steps'

on:
  workflow_call:

#  env:
#      BLUR: ${{ secrets.BLUR }}
#      PORT: ${{ secrets.PORT }}
#      API_KEY: ${{ secrets.API_KEY }}
#      APP_ENV: ${{ secrets.APP_ENV }}
#      NODE_ENV: ${{ secrets.NODE_ENV }}
#      SENTRY_URL: ${{ secrets.SENTRY_URL }}
#      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
#      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  deploy_canopy:
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # This ensures all history is fetched

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    - name: Install dependencies
      run: npm i

    - name: Build API
      run: npm run build:ts

    - name: Build Apps
      run: npm run build:apps

    - name: Deploy with rsync
      uses: burnett01/rsync-deployments@5.2.1
      with:
        switches: -avzc --delete --exclude="*.ts" --exclude=".git"
        path: ./
        remote_path: ${{ secrets.TARGET_DIR }}
        remote_host: ${{ secrets.HOST }}
        remote_user: ${{ secrets.USER }}
        remote_key: ${{ secrets.SSH_KEY }}

    - name: Restart Canopy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: pm2 restart canopy

